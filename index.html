<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <title>Golf Primos - Handicap Tracker</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f5132">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Golf Primos Handicap Tracker - Track golf scores, handicaps, and rankings for the Primos">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;700;800&display=swap');

    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --green-primary:#0f5132;
      --green-dark:#0a3d25;
      --gold:#d4af37;
      --gold-light:#ffd700;
      --red:#dc3545;

      /* slightly lighter grays (as in your current file) */
      --bg-dark:#242424;
      --bg-card:#333333;

      --text-primary:#e8e8e8;
      --text-secondary:#b0b0b0;
      --border:rgba(255,255,255,0.1);

      /* leaderboard sizing */
      --rank-col-w:64px;
      --golfer-col-w:14ch;
      --round-col-w:46px;
      --hcp-col-w:44px;
      --avg-col-w:52px;
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Outfit',sans-serif;
      background:var(--bg-dark);
      color:var(--text-primary);
      min-height:100vh;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
    }

    .header{
      background:linear-gradient(135deg,var(--green-primary) 0%,var(--green-dark) 100%);
      padding:15px;
      text-align:center;
      border-bottom:3px solid var(--gold);
      box-shadow:0 2px 10px rgba(0,0,0,0.5);
    }
    .logo{
      font-family:'Bebas Neue',sans-serif;
      font-size:1.5rem;
      letter-spacing:3px;
      color:var(--gold-light);
      text-shadow:2px 2px 4px rgba(0,0,0,0.5);
    }
    .subtitle{
      font-size:0.65rem;
      color:var(--text-secondary);
      letter-spacing:1.5px;
      text-transform:uppercase;
      font-weight:300;
      margin-top:3px;
    }

    .tab-nav{
      display:flex;
      background:var(--bg-card);
      border-bottom:2px solid var(--border);
      position:sticky; top: var(--safe-top); z-index:100;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .tab-nav::-webkit-scrollbar{display:none;}
    .tab-button{
      flex:1; min-width:100px;
      padding:14px 10px;
      background:transparent;
      border:none;
      color:var(--text-secondary);
      font-family:'Outfit',sans-serif;
      font-size:0.8rem;
      font-weight:600;
      cursor:pointer;
      transition:all .3s;
      text-transform:uppercase;
      letter-spacing:.5px;
      border-bottom:3px solid transparent;
      white-space:nowrap;
    }
    .tab-button:active{background:rgba(212,175,55,0.1);}
    .tab-button.active{
      color:var(--gold);
      border-bottom-color:var(--gold);
      background:rgba(212,175,55,0.1);
    }

    .tab-content{display:none; animation:fadeIn .3s ease-out;}
    .tab-content.active{display:block;}

    .container{max-width:100%; padding:12px;}

    /* Leaderboard layout */
    #leaderboard .container{
      min-height:calc(100dvh - 140px);
      display:flex;
      flex-direction:column;
    }

    .chart-container{
      background:var(--bg-card);
      border-radius:10px;
      padding:0;
      border:1px solid var(--border);
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }

    table.chart-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.65rem;
      table-layout:fixed;
    }

    .chart-table th,
    .chart-table td{
      border:1px solid var(--border);
      text-align:center;
      padding:5px 2px;
      background:var(--bg-card);
      font-size:0.65rem;
      transition:background .2s;
    }

    /* All header cells same green */
    .chart-table th{
      background:var(--green-dark) !important;
      color:var(--gold) !important;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:10;
      font-size:0.6rem;
      padding:6px 2px;
    }

    .chart-table td:active{background:rgba(212,175,55,0.1);}
    .chart-table tbody tr:hover{background:rgba(212,175,55,0.05);}

    /* Column widths */
    .col-rank{width:var(--rank-col-w); min-width:var(--rank-col-w); max-width:var(--rank-col-w);}
    .col-golfer{width:var(--golfer-col-w); min-width:var(--golfer-col-w); max-width:var(--golfer-col-w);}
    .col-round{width:var(--round-col-w); min-width:var(--round-col-w); max-width:var(--round-col-w);}
    .col-hcp{width:var(--hcp-col-w); min-width:var(--hcp-col-w); max-width:var(--hcp-col-w);}
    .col-avg{width:var(--avg-col-w); min-width:var(--avg-col-w); max-width:var(--avg-col-w);}

    /* Golfer cell text trimming to ~14 characters */
    .golfer-text{
      text-align:left;
      font-weight:600;
      color:var(--gold);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:5px 6px;
    }

    /* Sticky Rank + Golfer (portrait) */
    @media (orientation: portrait){
      .chart-table th.col-rank,
      .chart-table td.col-rank{
        position:sticky;
        left:0;
        z-index:12;
        background:var(--bg-card);
      }
      .chart-table th.col-golfer,
      .chart-table td.col-golfer{
        position:sticky;
        left:var(--rank-col-w);
        z-index:11;
        background:var(--bg-card);
      }
      /* keep header green while sticky */
      .chart-table th.col-rank,
      .chart-table th.col-golfer{
        background:var(--green-dark) !important;
      }
    }

    .handicap-col{
      background:rgba(212,175,55,0.1) !important;
      font-weight:700;
      color:var(--gold);
    }
    .avg-col{
      background:rgba(37,99,235,0.1) !important;
      font-weight:600;
    }

    /* FLOUNDERSVILLE ribbon */
    .flounders-row td{
      text-align:center;
      padding:4px;
      font-family:'Bebas Neue',sans-serif;
      font-size:0.75rem;
      color:var(--red);
      letter-spacing:1px;
      border-top:2px solid var(--red);
      border-bottom:2px solid var(--red);
      cursor:default;
      background:rgba(220,53,69,0.15) !important;
    }

    .share-container{
      text-align:center;
      margin-top:auto;
      padding:15px 15px max(15px, env(safe-area-inset-bottom));
    }

    button{
      padding:10px 16px;
      border:none;
      border-radius:8px;
      font-family:'Outfit',sans-serif;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .3s;
      text-transform:uppercase;
      letter-spacing:.5px;
      touch-action:manipulation;
    }
    button:active{transform:scale(.95);}
    .btn-primary{
      background:linear-gradient(135deg,var(--gold) 0%,var(--gold-light) 100%);
      color:var(--bg-dark);
      box-shadow:0 2px 10px rgba(212,175,55,0.2);
    }
    .btn-secondary{
      background:rgba(255,255,255,0.05);
      color:var(--text-primary);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{background:rgba(255,255,255,0.1);}
    .btn-share{
      background:linear-gradient(135deg,var(--gold) 0%,var(--gold-light) 100%);
      color:var(--bg-dark);
      padding:12px 24px;
      font-size:0.9rem;
      border-radius:8px;
      font-weight:700;
      box-shadow:0 4px 15px rgba(212,175,55,0.3);
    }

    .players-grid{display:grid; gap:10px;}
    .player-card{
      background:var(--bg-card);
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      transition:border-color .3s;
    }
    .player-card:hover{border-color:var(--gold);}
    .player-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
    .player-name{font-size:1rem; font-weight:600; color:var(--gold);}
    .player-stats{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
      font-size:0.8rem;
      color:var(--text-secondary);
      margin-bottom:10px;
    }
    .player-actions{
      display:grid;
      grid-template-columns:1fr auto auto auto;
      gap:6px;
    }
    .icon-btn{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--border);
      width:36px;height:36px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
    }
    .icon-btn:hover{background:rgba(255,255,255,0.1);}

    .settings-section{
      background:var(--bg-card);
      padding:15px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:15px;
    }
    .settings-title{
      font-size:1.1rem;
      font-weight:700;
      color:var(--gold);
      margin-bottom:12px;
      font-family:'Bebas Neue',sans-serif;
      letter-spacing:1.5px;
    }
    .settings-grid{display:grid; gap:12px;}
    label{
      font-size:0.8rem;
      color:var(--text-secondary);
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .input-group{display:flex; flex-direction:column;}
    input, select{
      width:100%;
      padding:10px;
      border:1px solid var(--border);
      border-radius:8px;
      background:rgba(255,255,255,0.03);
      color:var(--text-primary);
      font-size:0.9rem;
      font-family:'Outfit',sans-serif;
      transition:border-color .3s;
    }
    input:focus, select:focus{
      outline:none;
      border-color:var(--gold);
      box-shadow:0 0 0 3px rgba(212,175,55,0.1);
    }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.9);
      backdrop-filter:blur(5px);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:15px;
    }
    .modal.active{display:flex; animation:fadeIn .3s ease-out;}
    .modal-content{
      background:var(--bg-card);
      padding:20px;
      border-radius:12px;
      max-width:400px;
      width:100%;
      border:2px solid var(--gold);
      box-shadow:0 10px 50px rgba(0,0,0,0.7);
      max-height:85vh;
      overflow-y:auto;
      animation:scaleIn .3s ease-out;
    }
    .modal-header{
      font-family:'Bebas Neue',sans-serif;
      font-size:1.5rem;
      color:var(--gold);
      margin-bottom:15px;
      letter-spacing:1.5px;
    }
    .form-group{margin-bottom:15px;}
    .modal-buttons{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:20px;
    }

    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    @keyframes scaleIn{from{transform:scale(.9);opacity:0;}to{transform:scale(1);opacity:1;}}

    /* Fit-to-screen readability rules */
    .chart-table{font-size:clamp(0.55rem,1.15vw,0.70rem);}
    .chart-table th{font-size:clamp(0.50rem,1.05vw,0.65rem);}
    .chart-table td{font-size:clamp(0.55rem,1.15vw,0.70rem);}

    @media (orientation: landscape){
      /* slightly bigger in landscape while still fitting */
      .chart-table{font-size:clamp(0.60rem,1.10vw,0.78rem);}
      .chart-table th{font-size:clamp(0.55rem,1.00vw,0.72rem);}
      .chart-table td{font-size:clamp(0.60rem,1.10vw,0.78rem);}

      /* no horizontal scroll in landscape */
      .chart-container{overflow-x:hidden;}
      table.chart-table{width:100%;}
    }

    @media (max-width:480px){
      .logo{font-size:1.3rem;}
      .subtitle{font-size:0.6rem;}
      .tab-button{font-size:0.75rem; padding:12px 8px;}
      button{font-size:0.8rem; padding:8px 12px;}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">GOLF PRIMOS</div>
    <div class="subtitle">Handicap Tracker</div>
  </div>

  <div class="tab-nav">
    <button class="tab-button active" onclick="switchTab('leaderboard', event)">üèÜ Leaderboard</button>
    <button class="tab-button" onclick="switchTab('primos', event)">üèåÔ∏è Primos</button>
    <button class="tab-button" onclick="switchTab('settings', event)">‚öôÔ∏è Settings</button>
  </div>

  <div id="leaderboard" class="tab-content active">
    <div class="container">
      <div class="chart-container">
        <table class="chart-table" id="chartTable"></table>
      </div>
      <div class="share-container">
        <button class="btn-share" onclick="shareScreenshot()">üì∏ Share Screenshot</button>
      </div>
    </div>
  </div>

  <div id="primos" class="tab-content">
    <div class="container">
      <div style="text-align:center; margin-bottom:15px;">
        <button class="btn-primary" onclick="openAddPlayerModal()">Add New Primo</button>
      </div>
      <div id="primosContainer" class="players-grid"></div>
    </div>
  </div>

  <div id="settings" class="tab-content">
    <div class="container">
      <div class="settings-section">
        <div class="settings-title">Leaderboard Settings</div>
        <div class="settings-grid">
          <div class="input-group">
            <label>Flounderstown Handicap</label>
            <input type="number" id="floundersLineInput" value="105" min="0" inputmode="numeric">
            <p style="color:var(--text-secondary); font-size:0.75rem; margin-top:5px;">
              Players with handicap above this will be in Flounderstown
            </p>
          </div>

          <div class="input-group">
            <label>Average Cap Handicap</label>
            <input type="number" id="avgCapInput" value="110" min="0" inputmode="numeric">
            <p style="color:var(--text-secondary); font-size:0.75rem; margin-top:5px;">
              Players with average above this will show obfuscated average
            </p>
          </div>

          <div class="input-group">
            <label>Handicap Rule</label>
            <select id="handicapRuleSelect">
              <option value="best8">Best 8 of last 10 rounds</option>
              <option value="avg10">Average of last 10 rounds</option>
            </select>
            <p style="color:var(--text-secondary); font-size:0.75rem; margin-top:5px;">
              Choose how handicap is calculated (applies to all players)
            </p>
          </div>

          <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">Data Management</div>
        <div class="settings-grid">
          <button class="btn-secondary" onclick="exportData()">üì§ Export Data</button>
          <button class="btn-secondary" onclick="importData()">üì• Import Data</button>
          <button class="btn-secondary" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-title">About</div>
        <p style="color:var(--text-secondary); line-height:1.6; font-size:0.85rem;">
          <strong style="color:var(--gold);">Golf Primos Handicap Tracker</strong><br>
          Version 1.0.0<br><br>
          A progressive web app for tracking golf handicaps and scores for the Primos.
        </p>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="addPlayerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ADD NEW PRIMO</div>
      <div class="form-group">
        <label>Player Name</label>
        <input type="text" id="newPlayerName" placeholder="Enter player name">
      </div>
      <div class="form-group">
        <label>Initial Handicap</label>
        <input type="number" id="newPlayerHandicap" placeholder="Enter handicap" value="110" inputmode="numeric">
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="saveNewPlayer()">Add</button>
      </div>
    </div>
  </div>

  <div id="scoreModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="scoreModalHeader">ADD SCORE</div>
      <div id="scoreInputs"></div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="saveScore()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // --- Data model (unchanged) ---
    let appData = {
      players: [],
      courses: [],
      settings: { floundersLine: 105, avgCap: 110, handicapRule: 'best8' }
    };

    function loadData(){
      const saved = localStorage.getItem('golfPrimosData');
      if (saved){
        appData = JSON.parse(saved);
        appData.settings = appData.settings || { floundersLine: 105, avgCap: 110, handicapRule: 'best8' };
        if (!appData.settings.floundersLine) appData.settings.floundersLine = 105;
        if (!appData.settings.avgCap) appData.settings.avgCap = 110;
        if (!appData.settings.handicapRule) appData.settings.handicapRule = 'best8';
      }
      document.getElementById('floundersLineInput').value = appData.settings.floundersLine;
      document.getElementById('avgCapInput').value = appData.settings.avgCap;
      document.getElementById('handicapRuleSelect').value = appData.settings.handicapRule || 'best8';
    }

    function saveData(){
      localStorage.setItem('golfPrimosData', JSON.stringify(appData));
    }

    function calculateHandicap(scoreData){
      if (!scoreData || scoreData.length === 0) return 0;

      const scores = scoreData.map(s => (typeof s === 'object' ? s.score : s));
      const recent = scores.slice(-10);
      const rule = (appData.settings && appData.settings.handicapRule) ? appData.settings.handicapRule : 'best8';
      if (recent.length === 0) return 0;

      if (rule === 'avg10'){
        const avg10 = recent.reduce((sum, sc) => sum + sc, 0) / recent.length;
        return Math.round(avg10);
      }

      const sorted = [...recent].sort((a,b)=>a-b);
      const best8 = sorted.slice(0, Math.min(8, sorted.length));
      const avg = best8.reduce((sum, sc)=>sum+sc, 0) / best8.length;
      return Math.round(avg);
    }

    // --- Tabs ---
    function switchTab(tabName, ev){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (ev && ev.target) ev.target.classList.add('active');

      if (tabName === 'primos') renderPrimos();
      if (tabName === 'leaderboard') renderLeaderboard();
    }

    // --- Leaderboard ---
    function renderLeaderboard(){
      const table = document.getElementById('chartTable');
      const floundersLine = appData.settings.floundersLine;
      const avgCap = appData.settings.avgCap;

      if (appData.players.length === 0){
        table.innerHTML = '<tr><td style="text-align:center; padding:40px; color:var(--text-secondary);">No players yet. Add primos to get started!</td></tr>';
        return;
      }

      const sorted = [...appData.players].sort((a,b)=>a.handicap-b.handicap);
      const dal = sorted[sorted.length - 1];
      const topDawg = sorted[0];

      let html = '<thead><tr>';
      html += '<th class="col-rank">Rank</th>';
      html += '<th class="col-golfer">Golfer</th>';
      for (let i=10;i>=1;i--) html += `<th class="col-round">R-${i}</th>`;
      html += '<th class="col-hcp handicap-col">HCP</th>';
      html += '<th class="col-avg avg-col">Avg</th>';
      html += '</tr></thead><tbody>';

      sorted.forEach((player, index) => {
        const isDal = player.id === dal?.id;
        const isTopDawg = player.id === topDawg?.id && sorted.length > 1;
        const isFlounder = player.handicap > floundersLine;

        if (isFlounder && index > 0 && sorted[index - 1].handicap <= floundersLine){
          html += `<tr class="flounders-row"><td colspan="14">FLOUNDERSVILLE</td></tr>`;
        }

        let rankDisplay = `#${index+1}`;
        if (isTopDawg) rankDisplay = 'üèÜ Top Dawg';
        else if (isDal) rankDisplay = 'ü´è DAL';

        html += '<tr>';
        html += `<td class="col-rank">${rankDisplay}</td>`;
        html += `<td class="col-golfer golfer-text">${player.name}</td>`;

        const last10 = player.scores.slice(-10);
        const paddingNeeded = 10 - last10.length;

        for (let i=0;i<paddingNeeded;i++) html += `<td class="col-round">-</td>`;

        for (let i=0;i<last10.length;i++){
          const scoreData = last10[i];
          const score = (typeof scoreData === 'object' ? scoreData.score : scoreData);
          const scoreIndex = player.scores.length - last10.length + i;
          html += `<td class="col-round" onclick="openEditScoreModal('${player.id}', ${scoreIndex})" title="Click to edit">${score}</td>`;
        }

        let handicapDisplay = player.handicap;
        if (player.handicap > 110) handicapDisplay = '110';
        html += `<td class="col-hcp handicap-col">${handicapDisplay}</td>`;

        const last10Scores = player.scores.slice(-10).map(s => (typeof s === 'object' ? s.score : s));
        let avgDisplay = '-';
        if (last10Scores.length > 0){
          const avgValue = last10Scores.reduce((sum,s)=>sum+s,0) / last10Scores.length;
          if (avgValue > avgCap){
            const firstDigit = String(Math.round(avgValue))[0];
            avgDisplay = `${firstDigit}‚Ä¢‚Ä¢`;
          } else {
            avgDisplay = avgValue.toFixed(1);
          }
        }
        html += `<td class="col-avg avg-col">${avgDisplay}</td>`;
        html += '</tr>';
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    // --- Primos ---
    function renderPrimos(){
      const container = document.getElementById('primosContainer');
      if (appData.players.length === 0){
        container.innerHTML = '<p style="color:var(--text-secondary); text-align:center; padding:40px; font-size:0.9rem;">No primos yet. Click "Add New Primo" to get started!</p>';
        return;
      }

      const sorted = [...appData.players].sort((a,b)=>a.handicap-b.handicap);
      let html = '';

      sorted.forEach((player, index) => {
        const scores = player.scores.map(s => (typeof s === 'object' ? s.score : s));
        const worstScore = scores.length ? Math.max(...scores) : '-';
        const bestScore = scores.length ? Math.min(...scores) : '-';

        let rankDisplay = `#${index+1}`;
        if (index === 0 && sorted.length > 1) rankDisplay = 'üèÜ Top Dawg';
        else if (index === sorted.length - 1) rankDisplay = 'ü´è DAL';

        html += `
          <div class="player-card">
            <div class="player-header">
              <div class="player-name">${rankDisplay} - ${player.name}</div>
            </div>
            <div class="player-stats">
              <div><strong>Handicap:</strong> ${player.handicap}</div>
              <div><strong>Rounds:</strong> ${player.scores.length}</div>
              <div><strong>Best:</strong> ${bestScore}</div>
              <div><strong>Worst:</strong> ${worstScore}</div>
            </div>
            <div class="player-actions">
              <button class="btn-primary" onclick="openAddScoreModal('${player.id}')">‚ûï Add Score</button>
              <button class="icon-btn" onclick="viewPlayerScores('${player.id}')" title="View Scores">üìä</button>
              <button class="icon-btn" onclick="editPlayerName('${player.id}')" title="Edit">‚úèÔ∏è</button>
              <button class="icon-btn" onclick="deletePlayer('${player.id}')" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // --- Player CRUD ---
    function openAddPlayerModal(){
      document.getElementById('newPlayerName').value = '';
      document.getElementById('newPlayerHandicap').value = '110';
      document.getElementById('addPlayerModal').classList.add('active');
    }

    function saveNewPlayer(){
      const name = document.getElementById('newPlayerName').value.trim();
      const handicap = parseInt(document.getElementById('newPlayerHandicap').value) || 110;

      if (!name){ alert('Please enter a player name'); return; }

      appData.players.push({ id: Date.now() + Math.random(), name, handicap, scores: [] });

      saveData();
      renderPrimos();
      renderLeaderboard();
      closeModal();
    }

    function editPlayerName(playerId){
      const player = appData.players.find(p => p.id == playerId);
      if (!player) return;

      const newName = prompt('Enter new name:', player.name);
      if (newName && newName.trim()){
        player.name = newName.trim();
        saveData();
        renderPrimos();
        renderLeaderboard();
      }
    }

    function deletePlayer(playerId){
      if (!confirm('Remove this player?')) return;
      appData.players = appData.players.filter(p => p.id != playerId);
      saveData();
      renderPrimos();
      renderLeaderboard();
    }

    function viewPlayerScores(playerId){
      const player = appData.players.find(p => p.id == playerId);
      if (!player) return;

      const last10 = player.scores.slice(-10);
      const scoresHtml = last10.length
        ? last10.map((scoreData, i) => {
            const score = (typeof scoreData === 'object' ? scoreData.score : scoreData);
            const course = (typeof scoreData === 'object' && scoreData.course) ? scoreData.course : '?';
            return `R${player.scores.length - last10.length + i + 1}: ${score} (${course})`;
          }).join('\n')
        : 'No scores yet';

      alert(`${player.name}\n\nLast 10 Scores:\n${scoresHtml}\n\nHandicap: ${player.handicap}`);
    }

    // --- Scores ---
    function openAddScoreModal(playerId){
      const player = appData.players.find(p => p.id == playerId);
      if (!player) return;

      document.getElementById('scoreInputs').innerHTML = `
        <div class="form-group">
          <label>Player</label>
          <input type="text" value="${player.name}" disabled style="opacity:0.6;">
        </div>
        <div class="form-group">
          <label>Score</label>
          <input type="number" id="scoreValue" placeholder="Enter score" min="0" inputmode="numeric" autofocus>
        </div>
        <div class="form-group">
          <label>Course Name (Optional)</label>
          <input type="text" id="courseName" list="courseList" placeholder="Enter course">
          <datalist id="courseList">
            ${appData.courses.map(c => `<option value="${c}">`).join('')}
          </datalist>
        </div>
      `;

      const modal = document.getElementById('scoreModal');
      modal.classList.add('active');
      modal.dataset.playerId = playerId;
      modal.dataset.mode = 'add';
      document.getElementById('scoreModalHeader').textContent = 'ADD SCORE';
    }

    function openEditScoreModal(playerId, scoreIndex){
      const player = appData.players.find(p => p.id == playerId);
      if (!player || !player.scores[scoreIndex]) return;

      const scoreData = player.scores[scoreIndex];
      const currentScore = (typeof scoreData === 'object' ? scoreData.score : scoreData);
      const currentCourse = (typeof scoreData === 'object' && scoreData.course) ? scoreData.course : '';

      document.getElementById('scoreInputs').innerHTML = `
        <div class="form-group">
          <label>Player</label>
          <input type="text" value="${player.name}" disabled style="opacity:0.6;">
        </div>
        <div class="form-group">
          <label>Score</label>
          <input type="number" id="scoreValue" value="${currentScore}" min="0" inputmode="numeric" autofocus>
        </div>
        <div class="form-group">
          <label>Course Name (Optional)</label>
          <input type="text" id="courseName" value="${currentCourse}" list="courseList" placeholder="Enter course">
          <datalist id="courseList">
            ${appData.courses.map(c => `<option value="${c}">`).join('')}
          </datalist>
        </div>
        <div style="margin-top:15px;">
          <button class="btn-secondary" style="width:100%;" onclick="deleteScore('${playerId}', ${scoreIndex})">üóëÔ∏è Delete This Score</button>
        </div>
      `;

      const modal = document.getElementById('scoreModal');
      modal.classList.add('active');
      modal.dataset.playerId = playerId;
      modal.dataset.scoreIndex = scoreIndex;
      modal.dataset.mode = 'edit';
      document.getElementById('scoreModalHeader').textContent = 'EDIT SCORE';
    }

    function saveScore(){
      const modal = document.getElementById('scoreModal');
      const playerId = modal.dataset.playerId;
      const mode = modal.dataset.mode;
      const scoreIndex = parseInt(modal.dataset.scoreIndex);

      const player = appData.players.find(p => p.id == playerId);
      if (!player){ alert('Player not found'); return; }

      const scoreInput = document.getElementById('scoreValue');
      const courseInput = document.getElementById('courseName');
      const courseName = courseInput ? (courseInput.value.trim() || null) : null;

      if (!scoreInput || !scoreInput.value){ alert('Please enter a score'); return; }
      const score = parseInt(scoreInput.value);

      if (mode === 'edit'){
        player.scores[scoreIndex] = { score, course: courseName };
      } else {
        player.scores.push({ score, course: courseName });
      }

      player.handicap = calculateHandicap(player.scores);

      if (courseName && !appData.courses.includes(courseName)) appData.courses.push(courseName);

      saveData();
      renderPrimos();
      renderLeaderboard();
      closeModal();
    }

    function deleteScore(playerId, scoreIndex){
      if (!confirm('Delete this score?')) return;
      const player = appData.players.find(p => p.id == playerId);
      if (!player) return;

      player.scores.splice(scoreIndex, 1);
      player.handicap = calculateHandicap(player.scores);

      saveData();
      renderPrimos();
      renderLeaderboard();
      closeModal();
    }

    // --- Settings ---
    function saveSettings(){
      appData.settings.floundersLine = parseInt(document.getElementById('floundersLineInput').value);
      appData.settings.avgCap = parseInt(document.getElementById('avgCapInput').value);
      appData.settings.handicapRule = document.getElementById('handicapRuleSelect').value || (appData.settings.handicapRule || 'best8');

      appData.players.forEach(p => { p.handicap = calculateHandicap(p.scores); });

      saveData();
      renderLeaderboard();
      renderPrimos();
      alert('Settings saved successfully!');
    }

    // --- Data management ---
    function exportData(){
      const dataStr = JSON.stringify(appData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `golf-primos-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
          try{
            appData = JSON.parse(event.target.result);
            appData.settings = appData.settings || { floundersLine: 105, avgCap: 110, handicapRule: 'best8' };
            if (!appData.settings.floundersLine) appData.settings.floundersLine = 105;
            if (!appData.settings.avgCap) appData.settings.avgCap = 110;
            if (!appData.settings.handicapRule) appData.settings.handicapRule = 'best8';

            saveData();
            loadData();
            renderPrimos();
            renderLeaderboard();
            alert('Data imported successfully!');
          } catch(err){
            alert('Error importing data');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function clearAllData(){
      if (!confirm('Clear ALL data? This cannot be undone!')) return;
      localStorage.removeItem('golfPrimosData');
      location.reload();
    }

    // --- Modals ---
    function closeModal(){
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e){
        if (e.target === this) closeModal();
      });
    });

    // --- Screenshot sharing (unchanged behavior) ---
    async function shareScreenshot(){
      if (!window.html2canvas){
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => { script.onload = resolve; });
      }

      try{
        const container = document.querySelector('#leaderboard .container');
        const shareButton = document.querySelector('.share-container');
        if (shareButton) shareButton.style.display = 'none';

        const isPortrait = window.innerHeight > window.innerWidth;
        if (isPortrait){
          container.style.transform = 'rotate(90deg)';
          container.style.transformOrigin = 'center center';
        }

        const targetWidth = 1920, targetHeight = 1080;
        const scale = Math.min(targetWidth / container.offsetWidth, targetHeight / container.offsetHeight);

        const canvas = await html2canvas(container, {
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          scale,
          logging:false,
          width: container.offsetWidth,
          height: container.offsetHeight,
          windowWidth: targetWidth,
          windowHeight: targetHeight
        });

        if (isPortrait) container.style.transform = '';
        if (shareButton) shareButton.style.display = 'block';

        const finalCanvas = document.createElement('canvas');
        if (isPortrait){
          finalCanvas.width = canvas.height;
          finalCanvas.height = canvas.width;
          const ctx = finalCanvas.getContext('2d');
          ctx.translate(finalCanvas.width/2, finalCanvas.height/2);
          ctx.rotate(90 * Math.PI/180);
          ctx.drawImage(canvas, -canvas.width/2, -canvas.height/2);
        } else {
          finalCanvas.width = canvas.width;
          finalCanvas.height = canvas.height;
          finalCanvas.getContext('2d').drawImage(canvas, 0, 0);
        }

        finalCanvas.toBlob(async (blob) => {
          const file = new File([blob], 'golf-primos-leaderboard.png', { type: 'image/png' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
            try{
              await navigator.share({ files:[file], title:'Golf Primos Leaderboard', text:'Check out our Golf Primos leaderboard!' });
            } catch(err){
              if (err.name !== 'AbortError') downloadImage(finalCanvas);
            }
          } else {
            downloadImage(finalCanvas);
          }
        });
      } catch(err){
        console.error('Screenshot error:', err);
        alert('Unable to capture screenshot. Please try taking a manual screenshot.');
        const container = document.querySelector('#leaderboard .container');
        if (container) container.style.transform = '';
        const shareButton = document.querySelector('.share-container');
        if (shareButton) shareButton.style.display = 'block';
      }
    }

    function downloadImage(canvas){
      const link = document.createElement('a');
      link.download = `golf-primos-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    }

    // --- Service worker registration (same behavior) ---
    if ('serviceWorker' in navigator){
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });

      window.addEventListener('load', async () => {
        try{
          const registration = await navigator.serviceWorker.register('./sw.js');
          setInterval(() => { registration.update(); }, 60000);

          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller){
                newWorker.postMessage({ action: 'skipWaiting' });
              }
            });
          });
        } catch(error){
          console.log('[PWA] Service Worker registration failed:', error);
        }
      });
    }

    // init
    loadData();
    renderLeaderboard();
  </script>
</body>
</html>
